<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GramSathi Dashboard</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<link rel="stylesheet" href="dashboard.css">
</head>
<body>

<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>GramSathi</h2>
    <a class="nav-link active" href="dashboard.html">Dashboard</a>
    <a class="nav-link" href="climate-risk.html">Climate Risk</a>
    <a class="nav-link" href="crop-safe.html">Crop Safety</a>
    <a class="nav-link" href="market-insights.html">Market Insight</a>
    <a class="nav-link" href="#" onclick="logout()">Logout</a>
  </aside>

  <!-- Main Content -->
  <main class="content">

    <div class="welcome" id="welcomeText">Welcome</div>

    <section class="cards">

      <!-- Inputs -->
      <div class="card">
        <h3>Farm Details</h3>

        <label class="label">Crop</label>
        <select id="cropSelect" class="input">
          <option value="">Choose crop</option>
          <option>Rice</option>
          <option>Wheat</option>
          <option>Maize</option>
        </select>

        <label class="label" style="margin-top:12px;display:block;">Location</label>
        <input id="locationInput" class="input" placeholder="Village / District" />

        <button class="primary-btn" onclick="applyInputs()">Apply</button>
      </div>

      <div class="card">
        <h3>Climate Status</h3>
        <div id="climateStatus" class="value">--</div>
      </div>

      <div class="card">
        <h3>Crop Safety</h3>
        <div id="cropStatus" class="value">--</div>
      </div>

      <div class="card">
        <h3>Market Advice</h3>
        <div id="marketStatus" class="value">--</div>
      </div>

      <div class="card">
        <h3>Estimated Yield</h3>
        <div id="yield" class="value">--</div>
      </div>

    </section>

    <div class="info">
      Uses real climate data from Open‑Meteo and location data from OpenStreetMap. Market advice is generated using crop‑specific agronomic rules.
    </div>

  </main>
</div>

<script>
  /* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCvT-E2cHv7kdVgTHVlpttyKkpiK9EzMaI",
  authDomain: "nexu-3d034.firebaseapp.com",
  projectId: "nexu-3d034",
  storageBucket: "nexu-3d034.firebasestorage.app",
  messagingSenderId: "174169137790",
  appId: "1:174169137790:web:e70a8aa65adb38f93d2e2f"
};
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  firebase.auth().onAuthStateChanged(user => {
    if (!user) location = 'login.html';
    else welcomeText.innerText = `Welcome, ${user.displayName || 'Farmer'}`;
  });

  function logout() {
    firebase.auth().signOut().then(() => location = 'login.html');
  }

  /* ================= REAL DATA LOGIC ================= */
  async function getCoordinates(place) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${place}`);
    const data = await res.json();
    if (!data.length) throw 'Location not found';
    return { lat:data[0].lat, lon:data[0].lon };
  }

  async function getWeather(lat, lon) {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation&timezone=auto`);
    return await res.json();
  }

  function climateRisk(crop, temp, rain) {

    // Agronomy-based realistic thresholds
    if (crop === "Rice") {
      if (temp < 18 || temp > 38) return "High";
      if (temp < 20 || temp > 35) return "Medium";
      return "Low";
    }

    if (crop === "Wheat") {
      if (temp < 5 || temp > 32) return "High";
      if (temp < 10 || temp > 25) return "Medium";
      return "Low";
    }

    if (crop === "Maize") {
      if (temp < 10 || temp > 35) return "High";
      if (temp < 18 || temp > 30) return "Medium";
      return "Low";
    }
  }

  function marketAdvice(crop, t, r) {
    if (crop==='Rice') return t>32?'Sell':'Hold';
    if (crop==='Wheat') return t<30?'Hold':'Sell';
    if (crop==='Maize') return r>8?'Wait':'Sell';
  }

  async function applyInputs() {
    const crop = cropSelect.value;
    const loc = locationInput.value.trim();
    if (!crop || !loc) return alert('Enter crop and location');

    try {
      const {lat,lon} = await getCoordinates(loc);
      const w = await getWeather(lat,lon);
      const t = w.current.temperature_2m;
      const r = w.current.precipitation;

      const risk = climateRisk(crop,t,r);

      climateStatus.innerText = `${risk} (${t}°C)`;
      climateStatus.className = `value ${risk==='High'?'high':risk==='Medium'?'medium':'safe'}`;

      cropStatus.innerText = risk;
      cropStatus.className = climateStatus.className;

      marketStatus.innerText = marketAdvice(crop,t,r);
      yield.innerText = risk==='High'?'60%':risk==='Medium'?'75%':'85%';

    } catch(e) {
      alert('Unable to fetch real data');
    }
  }
</script>

</body>
</html>
